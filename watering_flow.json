[
    {
        "id": "watering_flow",
        "type": "tab",
        "label": "üíß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∏–≤–æ–º",
        "disabled": false,
        "info": "–ü–æ—Ç–æ–∫ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–∏–≤–æ–º –∏ –¥—Ä–µ–Ω–∞–∂–µ–º"
    },
    {
        "id": "watering_trigger",
        "type": "server-state-changed",
        "z": "watering_flow",
        "name": "–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–∞—Ç—á–∏–∫–æ–≤",
        "server": "79fe7aa8.47ef74",
        "version": 3,
        "exposeToHomeAssistant": false,
        "haConfig": [
            {
                "property": "name",
                "value": ""
            },
            {
                "property": "icon",
                "value": ""
            }
        ],
        "entityidfilter": "sensor.gw2000a_soil_moisture_2",
        "entityidfiltertype": "exact",
        "outputinitially": false,
        "state_type": "str",
        "haltifstate": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "outputs": 1,
        "output_only_on_state_change": true,
        "for": 0,
        "forType": "num",
        "forUnits": "minutes",
        "ignorePrevStateNull": false,
        "ignorePrevStateUnknown": false,
        "ignorePrevStateUnavailable": false,
        "ignoreCurrentStateUnknown": false,
        "ignoreCurrentStateUnavailable": false,
        "x": 200,
        "y": 100,
        "wires": [
            ["watering_sensors"]
        ]
    },
    {
        "id": "watering_sensors",
        "type": "api-current-state",
        "z": "watering_flow",
        "name": "–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–∞—Ç—á–∏–∫–æ–≤",
        "server": "79fe7aa8.47ef74",
        "version": 3,
        "outputs": 1,
        "halt_if": "",
        "halt_if_type": "str",
        "halt_if_compare": "is",
        "entity_id": "sensor.gw2000a_soil_moisture_2,sensor.ws2350_v2_37_humidity,sensor.ws2350_v2_37_daily_rain_rate,sensor.ws2350_v2_37_uv_index,sensor.ws2350_v2_37_solar_radiation,sensor.ws2350_v2_37_dewpoint,sensor.ws2350_v2_37_wind_speed",
        "state_type": "str",
        "blockInputOverrides": false,
        "outputProperties": [
            {
                "property": "payload",
                "propertyType": "msg",
                "value": "",
                "valueType": "entityState"
            }
        ],
        "x": 400,
        "y": 100,
        "wires": [
            ["watering_decision"]
        ]
    },
    {
        "id": "watering_decision",
        "type": "function",
        "z": "watering_flow",
        "name": "–ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏—è –æ –ø–æ–ª–∏–≤–µ",
        "func": "const soilMoisture = parseFloat(msg.payload.soil_moisture) || 0;\nconst humidity = parseFloat(msg.payload.humidity) || 0;\nconst dailyRain = parseFloat(msg.payload.daily_rain) || 0;\nconst uv = parseFloat(msg.payload.uv) || 0;\nconst solar = parseFloat(msg.payload.solar) || 0;\nconst dewPoint = parseFloat(msg.payload.dew_point) || 0;\nconst windSpeed = parseFloat(msg.payload.wind_speed) || 0;\nconst openmeteo = msg.openmeteo || { \n  rain_today: 0, rain_tomorrow: 0,\n  et0_today: 0, et0_tomorrow: 0,\n  temp_min_today: 0, temp_min_tomorrow: 0\n};\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –ø–æ–ª–∏–≤–∞ (–Ω–µ —Ä–∞–Ω—å—à–µ 6:00)\nconst now = new Date();\nconst currentHour = now.getHours();\nconst currentMinute = now.getMinutes();\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –¥–ª—è –ø–æ–ª–∏–≤–∞\nconst isSafeTime = currentHour >= 6 && currentHour < 8; // –ü–æ–ª–∏–≤ —Ç–æ–ª—å–∫–æ —Å 6:00 –¥–æ 8:00\nconst isSafeUV = uv < 2; // UV –∏–Ω–¥–µ–∫—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–µ–Ω—å—à–µ 2\nconst isSafeSolar = solar < 100; // –°–æ–ª–Ω–µ—á–Ω–∞—è —Ä–∞–¥–∏–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–Ω—å—à–µ 100 –í—Ç/–º¬≤\nconst isDewPointSafe = dewPoint < 15; // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ç–æ—á–∫–∞ —Ä–æ—Å—ã –¥–ª—è –≥–∞–∑–æ–Ω–∞\nconst isWindSafe = windSpeed < 15; // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞ –¥–ª—è –ø–æ–ª–∏–≤–∞ (–∫–º/—á)\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è –¥–ª—è –¥—Ä–µ–Ω–∞–∂–∞\nconst isWarmEnough = openmeteo.temp_min_today > 0 && openmeteo.temp_min_tomorrow > 0; // –Ω–µ—Ç –∑–∞–º–æ—Ä–æ–∑–∫–æ–≤\nconst needsDrainage = isWarmEnough && ( // —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤—ã—à–µ –Ω—É–ª—è –ò\n    soilMoisture > 50 || // –≤—ã—Å–æ–∫–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å –ø–æ—á–≤—ã –ò–õ–ò\n    dailyRain > 5 || // –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –æ—Å–∞–¥–∫–∏ –∑–∞ –¥–µ–Ω—å –ò–õ–ò\n    dewPoint >= 15 // –≤—ã—Å–æ–∫–∞—è —Ç–æ—á–∫–∞ —Ä–æ—Å—ã\n);\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –ø–æ–ª–∏–≤–∞ —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö —É—Å–ª–æ–≤–∏–π\nconst needsWatering = soilMoisture < 40 && // –Ω–∏–∑–∫–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å –ø–æ—á–≤—ã\n                     humidity < 70 && // –Ω–∏–∑–∫–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å –≤–æ–∑–¥—É—Ö–∞\n                     openmeteo.et0_today > 3 && // –≤—ã—Å–æ–∫–∞—è –∏—Å–ø–∞—Ä—è–µ–º–æ—Å—Ç—å\n                     openmeteo.rain_today < 5 && // –Ω–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã—Ö –æ—Å–∞–¥–∫–æ–≤ —Å–µ–≥–æ–¥–Ω—è\n                     openmeteo.rain_tomorrow < 5 && // –Ω–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã—Ö –æ—Å–∞–¥–∫–æ–≤ –∑–∞–≤—Ç—Ä–∞\n                     isSafeTime && // –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—Ä–µ–º—è\n                     isSafeUV && // –±–µ–∑–æ–ø–∞—Å–Ω—ã–π UV –∏–Ω–¥–µ–∫—Å\n                     isSafeSolar && // –±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–æ–ª–Ω–µ—á–Ω–∞—è —Ä–∞–¥–∏–∞—Ü–∏—è\n                     isDewPointSafe && // –±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ç–æ—á–∫–∞ —Ä–æ—Å—ã\n                     isWindSafe; // –±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞\n\n// –†–∞—Å—á–µ—Ç –æ–±—ä–µ–º–∞ –≤–æ–¥—ã –¥–ª—è –ø–æ–ª–∏–≤–∞ (–ª/–º¬≤)\nlet wateringAmount = 0;\nif (needsWatering) {\n    // –ë–∞–∑–æ–≤—ã–π –æ–±—ä–µ–º 10-15 –ª/–º¬≤ —Å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–æ–π –Ω–∞ –∏—Å–ø–∞—Ä—è–µ–º–æ—Å—Ç—å\n    wateringAmount = 10 + Math.min(5, openmeteo.et0_today - 3);\n    \n    // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –Ω–∞ –≤–ª–∞–∂–Ω–æ—Å—Ç—å –ø–æ—á–≤—ã\n    if (soilMoisture < 30) {\n        wateringAmount += 2; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø—Ä–∏ –æ—á–µ–Ω—å —Å—É—Ö–æ–π –ø–æ—á–≤–µ\n    } else if (soilMoisture > 35) {\n        wateringAmount -= 2; // –£–º–µ–Ω—å—à–∞–µ–º –ø—Ä–∏ –ø–æ—á–≤–µ –±–ª–∏–∂–µ –∫ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π\n    }\n    \n    // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞\n    if (windSpeed > 5) {\n        wateringAmount += Math.min(2, windSpeed / 5); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø—Ä–∏ –≤–µ—Ç—Ä–µ\n    }\n    \n    // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –Ω–∞ —Ç–æ—á–∫—É —Ä–æ—Å—ã\n    if (dewPoint > 10) {\n        wateringAmount -= Math.min(2, (dewPoint - 10) / 2); // –£–º–µ–Ω—å—à–∞–µ–º –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π —Ç–æ—á–∫–µ —Ä–æ—Å—ã\n    }\n    \n    // –£—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–≥–Ω–æ–∑ –æ—Å–∞–¥–∫–æ–≤ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è\n    if (openmeteo.rain_today > 0 && openmeteo.rain_today < 5) {\n        wateringAmount -= openmeteo.rain_today; // –£–º–µ–Ω—å—à–∞–µ–º –Ω–∞ –æ–±—ä–µ–º –æ–∂–∏–¥–∞–µ–º—ã—Ö –æ—Å–∞–¥–∫–æ–≤\n    }\n    \n    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ\n    wateringAmount = Math.max(8, Math.min(17, wateringAmount));\n}\n\n// –û–±—â–∏–π –æ–±—ä–µ–º –¥–ª—è –≤—Å–µ–π –ø–ª–æ—â–∞–¥–∏ (300 –∫–≤.–º)\nconst totalWateringAmount = wateringAmount * 300;\n\n// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–µ–ª–µ–≤–æ–π –æ–±—ä–µ–º –≤–æ–¥—ã –∏ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –ø–æ–ª–∏–≤–∞\nglobal.set('watering_target_volume', totalWateringAmount);\nglobal.set('watering_start_time', new Date().getTime());\n\n// –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏—á–∏–Ω–∞—Ö –æ—Ç–∫–∞–∑–∞ –æ—Ç –ø–æ–ª–∏–≤–∞\nconst reasons = [];\nif (!isSafeTime) {\n    reasons.push(`–í—Ä–µ–º—è –ø–æ–ª–∏–≤–∞ –Ω–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–µ (${currentHour}:${currentMinute})`);\n}\nif (!isSafeUV) {\n    reasons.push(`UV –∏–Ω–¥–µ–∫—Å —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–π (${uv})`);\n}\nif (!isSafeSolar) {\n    reasons.push(`–°–æ–ª–Ω–µ—á–Ω–∞—è —Ä–∞–¥–∏–∞—Ü–∏—è —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∞—è (${solar} –í—Ç/–º¬≤)`);\n}\nif (!isDewPointSafe) {\n    reasons.push(`–¢–æ—á–∫–∞ —Ä–æ—Å—ã —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∞—è (${dewPoint}¬∞C)`);\n}\nif (!isWindSafe) {\n    reasons.push(`–°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞ —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∞—è (${windSpeed} –∫–º/—á)`);\n}\n\nmsg.payload = { \n    needsWatering: needsWatering, \n    needsDrainage: needsDrainage, \n    wateringAmountPerSqm: wateringAmount, \n    totalWateringAmount: totalWateringAmount, \n    area: 300, \n    soilMoisture: soilMoisture, \n    humidity: humidity, \n    dailyRain: dailyRain, \n    et0Today: openmeteo.et0_today, \n    rainToday: openmeteo.rain_today, \n    rainTomorrow: openmeteo.rain_tomorrow, \n    uv: uv, \n    solar: solar,\n    dewPoint: dewPoint,\n    windSpeed: windSpeed,\n    currentTime: `${currentHour}:${currentMinute}`, \n    safetyReasons: reasons \n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 600,
        "y": 100,
        "wires": [
            ["watering_telegram"]
        ]
    },
    {
        "id": "watering_telegram",
        "type": "function",
        "z": "watering_flow",
        "name": "–°–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–ª–∏–≤–µ",
        "func": "const data = msg.payload;\nlet message = '';\n\nif (data.needsWatering) {\n    message = `üíß *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ –ø–æ–ª–∏–≤—É:*\n\n`;\n    message += `üå± –í–ª–∞–∂–Ω–æ—Å—Ç—å –ø–æ—á–≤—ã: *${data.soilMoisture}%*\n`;\n    message += `üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å –≤–æ–∑–¥—É—Ö–∞: *${data.humidity}%*\n`;\n    message += `üåßÔ∏è –û—Å–∞–¥–∫–∏ –∑–∞ –¥–µ–Ω—å: *${data.dailyRain} –º–º*\n`;\n    message += `‚òÄÔ∏è UV –∏–Ω–¥–µ–∫—Å: *${data.uv}*\n`;\n    message += `üå°Ô∏è –¢–æ—á–∫–∞ —Ä–æ—Å—ã: *${data.dewPoint}¬∞C*\n`;\n    message += `üå¨Ô∏è –í–µ—Ç–µ—Ä: *${data.windSpeed} –∫–º/—á*\n\n`;\n    message += `üìä *–†–∞—Å—á–µ—Ç –ø–æ–ª–∏–≤–∞:*\n`;\n    message += `‚Ä¢ –ù–æ—Ä–º–∞ –Ω–∞ 1 –º¬≤: *${data.wateringAmountPerSqm.toFixed(1)} –ª*\n`;\n    message += `‚Ä¢ –û–±—â–∏–π –æ–±—ä–µ–º: *${data.totalWateringAmount.toFixed(0)} –ª*\n`;\n    message += `‚Ä¢ –ü–ª–æ—â–∞–¥—å: *${data.area} –º¬≤*\n\n`;\n    message += `‚è∞ –í—Ä–µ–º—è: *${data.currentTime}*`;\n} else if (data.needsDrainage) {\n    message = `‚ö†Ô∏è *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ –¥—Ä–µ–Ω–∞–∂—É:*\n\n`;\n    message += `üå± –í–ª–∞–∂–Ω–æ—Å—Ç—å –ø–æ—á–≤—ã: *${data.soilMoisture}%*\n`;\n    message += `üåßÔ∏è –û—Å–∞–¥–∫–∏ –∑–∞ –¥–µ–Ω—å: *${data.dailyRain} –º–º*\n`;\n    message += `üå°Ô∏è –¢–æ—á–∫–∞ —Ä–æ—Å—ã: *${data.dewPoint}¬∞C*\n\n`;\n    message += `‚ùóÔ∏è –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤–∫–ª—é—á–∏—Ç—å –¥—Ä–µ–Ω–∞–∂ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ—É–≤–ª–∞–∂–Ω–µ–Ω–∏—è –ø–æ—á–≤—ã.`;\n} else {\n    message = `‚ÑπÔ∏è *–°—Ç–∞—Ç—É—Å –ø–æ–ª–∏–≤–∞:*\n\n`;\n    message += `üå± –í–ª–∞–∂–Ω–æ—Å—Ç—å –ø–æ—á–≤—ã: *${data.soilMoisture}%*\n`;\n    message += `üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å –≤–æ–∑–¥—É—Ö–∞: *${data.humidity}%*\n`;\n    message += `üåßÔ∏è –û—Å–∞–¥–∫–∏ –∑–∞ –¥–µ–Ω—å: *${data.dailyRain} –º–º*\n\n`;\n    if (data.safetyReasons.length > 0) {\n        message += `‚ùå *–ü—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–∞–∑–∞ –æ—Ç –ø–æ–ª–∏–≤–∞:*\n`;\n        data.safetyReasons.forEach(reason => {\n            message += `‚Ä¢ ${reason}\n`;\n        });\n    } else {\n        message += `‚úÖ –ü–æ–ª–∏–≤ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è - –≤—Å–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –≤ –Ω–æ—Ä–º–µ.`;\n    }\n}\n\nmsg.payload = {\n    chatId: env.get('TELEGRAM_CHAT_ID') || '-1001548038296',\n    type: 'message',\n    content: message\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 800,
        "y": 100,
        "wires": [
            ["watering_sender"]
        ]
    },
    {
        "id": "watering_sender",
        "type": "telegram sender",
        "z": "watering_flow",
        "name": "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é",
        "bot": "df690a6504c1e710",
        "haserroroutput": false,
        "outputs": 1,
        "x": 1000,
        "y": 100,
        "wires": [
            []
        ]
    }
] 